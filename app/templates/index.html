<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рекомендатель Цены Ставки</title>
    <!-- Pico.css for styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body { padding: 2rem; }
        .container { max-width: 768px; }
        #result { margin-top: 1.5rem; padding: 1.5rem; border: 1px solid var(--primary-border); border-radius: var(--border-radius); }
        #result.hidden { display: none; }
        #result h4 { margin-bottom: 0.5rem; }
        #result p { margin-bottom: 0; }
        .loader { display: none; width: 20px; height: 20px; border: 3px solid var(--secondary); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <main class="container">
        <hgroup>
            <h1>Рекомендатель Цены Ставки</h1>
            <h2>Введите данные заказа, чтобы получить рекомендацию по оптимальной цене ставки.</h2>
        </hgroup>

        <form id="order-form">
            <div class="grid">
                <label for="price_start_local">
                    Начальная цена (местная)
                    <input type="number" id="price_start_local" name="price_start_local" value="150" required>
                </label>
                <label for="driver_reg_date">
                    Дата регистрации водителя
                    <input type="date" id="driver_reg_date" name="driver_reg_date" value="2022-01-15" required>
                </label>
            </div>

            <div class="grid">
                <label for="platform">
                    Платформа
                    <select id="platform" name="platform" required>
                        <option value="android" selected>Android</option>
                        <option value="ios">iOS</option>
                        <option value="other">Другое</option>
                    </select>
                </label>
                <label for="car_class">
                    Класс автомобиля
                    <select id="car_class" name="car_class" required>
                        <option value="econom" selected>Эконом</option>
                        <option value="comfort">Комфорт</option>
                        <option value="business">Бизнес</option>
                    </select>
                </label>
            </div>

            <button type="submit" id="submit-btn">
                <span>Рассчитать оптимальную цену</span>
                <div class="loader" id="loader"></div>
            </button>
        </form>

        <article id="result" class="hidden">
            <h4>Все рекомендации:</h4>
            <div id="result-text"></div>
        </article>
    </main>

    <script>
        document.getElementById('order-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const form = event.target;
            const resultDiv = document.getElementById('result');
            const resultText = document.getElementById('result-text');
            const submitBtn = document.getElementById('submit-btn');
            const loader = document.getElementById('loader');

            // Show loader and disable button
            loader.style.display = 'inline-block';
            submitBtn.disabled = true;
            resultDiv.classList.add('hidden');

            const formData = {
                price_start_local: parseFloat(form.price_start_local.value),
                platform: form.platform.value,
                car_class: form.car_class.value,
                driver_reg_date: form.driver_reg_date.value
            };

            try {
                const response = await fetch('/recommend_price', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.error) {
                        resultText.textContent = `Ошибка: ${data.error}`;
                    } else if (data.recommendations) {
                        resultText.innerHTML = ''; // Clear previous results

                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Рекомендуемая цена</th>
                                    <th>Вероятность успеха</th>
                                    <th>Ожидаемый доход</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        `;
                        const tbody = table.querySelector('tbody');

                        data.recommendations.forEach(rec => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${rec.recommended_price.toFixed(2)}</td>
                                <td>${(rec.success_probability * 100).toFixed(2)}%</td>
                                <td>${rec.expected_income.toFixed(2)}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                        resultText.appendChild(table);

                    }
                } else {
                    resultText.textContent = `Ошибка: ${data.detail || 'Произошла неизвестная ошибка.'}`;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                resultText.textContent = 'Произошла ошибка при связи с сервером.';
            } finally {
                // Hide loader and re-enable button
                loader.style.display = 'none';
                submitBtn.disabled = false;
                resultDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
